<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Deriv Members Dashboard</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800;900&display=swap" rel="stylesheet">

<style>
  body {
    margin: 0;
    font-family: 'Inter', sans-serif;
    background: #f4f5f7;
    color: #111;
  }

  .header {
    background: #111;
    padding: 16px 24px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    color: white;
    position: sticky;
    top: 0;
    z-index: 10;
  }

  .logout-btn {
    background: #ff4459;
    border: none;
    padding: 10px 16px;
    border-radius: 8px;
    color: white;
    cursor: pointer;
    font-weight: 700;
  }

  .container {
    max-width: 1100px;
    margin: 30px auto;
    padding: 0 16px;
  }

  .section {
    background: white;
    padding: 26px;
    border-radius: 12px;
    margin-bottom: 26px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
  }

  h1 { font-size: 28px; font-weight: 800; margin-bottom: 14px; }
  h2 { font-size: 22px; font-weight: 700; margin-top: 0; }

  .balance {
    font-size: 36px;
    font-weight: 900;
    margin: 10px 0;
  }

  .btn {
    display: inline-block;
    padding: 12px 18px;
    border-radius: 8px;
    font-weight: 700;
    cursor: pointer;
    border: none;
    color: white;
    margin-top: 10px;
  }

  .btn-red { background: #ff4459; }
  .btn-black { background: #111; }

  .product-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(290px, 1fr));
    gap: 20px;
  }

  .card {
    background: white;
    padding: 20px;
    border-radius: 12px;
    box-shadow: 0 1px 6px rgba(0,0,0,0.08);
  }

  .bonus-item {
    background: #e8e8e8;
    padding: 14px;
    border-radius: 8px;
    margin-top: 10px;
  }

  /* Deposit modals */
  .modal-bg {
    position: fixed;
    inset: 0;
    display: none;
    justify-content: center;
    align-items: center;
    background: rgba(0,0,0,0.6);
    z-index: 999;
  }

  .modal-content {
    background: #fff;
    padding: 26px;
    width: 360px;
    border-radius: 12px;
    text-align: center;
  }

  .modal-content input {
    width: 100%;
    padding: 12px;
    margin-top: 12px;
    border-radius: 8px;
    border: 1px solid #ccc;
    font-size: 16px;
  }
</style>
</head>

<body>

<!-- HEADER -->
<div class="header">
  <div style="font-size:20px; font-weight:800;">Deriv Members Portal</div>
  <button class="logout-btn" onclick="logout()">Log out</button>
</div>

<div class="container">

  <!-- WALLET SECTION -->
  <div class="section">
    <h1>Wallet</h1>
    <p>Your available balance:</p>
    <div id="balance" class="balance">0</div>

    <button class="btn btn-red" onclick="openDeposit()">Deposit</button>
    <button class="btn btn-black" onclick="openPayout()">Request Payout</button>
  </div>

  <!-- BONUS FEATURES -->
  <div class="section">
    <h1>Bonus Features</h1>
    <div id="bonusList"></div>
  </div>

  <!-- SERVICES -->
  <div class="section">
    <h1>Available Services</h1>

    <div class="product-grid">

      <div class="card">
        <h2>Weekly Syndicate</h2>
        <p>Earn weekly returns from our trading pool.</p>
        <button class="btn btn-black" onclick="buyProduct('Weekly Syndicate', weeklyPrice)">Join</button>
      </div>

      <div class="card">
        <h2>Signals Group</h2>
        <p>Get high-quality signals on request.</p>
        <button class="btn btn-black" onclick="buyProduct('Signals Group', signalsPrice)">Join</button>
      </div>

      <div class="card">
        <h2>Monthly Syndicate</h2>
        <p>Stable monthly returns.</p>
        <button class="btn btn-black" onclick="buyProduct('Monthly Syndicate', monthlyPrice)">Join</button>
      </div>

    </div>
  </div>

  <!-- DEPOSIT HISTORY -->
  <div class="section">
    <h1>Deposit History</h1>
    <div id="depositHistory"></div>
  </div>

</div>

<!-- DEPOSIT SELECT MODAL -->
<div id="depositModal" class="modal-bg">
  <div class="modal-content">
    <h2>Select Deposit Method</h2>
    <button class="btn btn-black" onclick="showBank()">Bank Deposit</button>
    <button class="btn btn-red" onclick="showXRP()">Deposit with XRP</button>
    <button class="btn btn-black" style="background:#666;" onclick="closeDeposit()">Cancel</button>
  </div>
</div>

<!-- BANK MODAL -->
<div id="bankModal" class="modal-bg">
  <div class="modal-content">
    <h2>Bank Deposit</h2>
    <p><strong>Bank:</strong> Nedbank</p>
    <p><strong>Account Number:</strong> 1236268857</p>
    <p><strong>Reference:</strong> Your Name + Surname</p>

    <input id="bankAmount" type="number" placeholder="Amount">

    <button class="btn btn-black" onclick="submitDeposit('bank')">I’ve Deposited</button>
    <button class="btn btn-black" style="background:#666;" onclick="closeBank()">Cancel</button>
  </div>
</div>

<!-- XRP MODAL -->
<div id="xrpModal" class="modal-bg">
  <div class="modal-content">
    <h2>Deposit with XRP</h2>

    <img src="images/xrp_qr.png" style="width:180px;">

    <p><strong>Address:</strong><br> rsRy14FvipgqudiGmptJBhr1RtpsgfzKMM</p>
    <p><strong>Tag:</strong> 1574868947</p>

    <input id="xrpAmount" type="number" placeholder="Amount (USD)">
    <button class="btn btn-red" onclick="submitDeposit('xrp')">I’ve Sent the XRP</button>
    <button class="btn btn-black" style="background:#666;" onclick="closeXRP()">Cancel</button>
  </div>
</div>

<!-- PAYOUT MODAL -->
<div id="payoutModal" class="modal-bg">
  <div class="modal-content">
    <h2>Payout Request</h2>
    <input id="payoutAmount" type="number" placeholder="Amount">
    <button onclick="submitPayout()" class="btn btn-red">Submit Request</button>
    <button onclick="closePayout()" class="btn btn-black" style="background:#666;">Cancel</button>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>

const supabaseClient = supabase.createClient(
  "https://whnnyuozicuphrpgomno.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Indobm55dW96aWN1cGhycGdvbW5vIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM1Mjk3MDAsImV4cCI6MjA3OTEwNTcwMH0.XTS5-ELx7sUmZmkyoXG1B1zOqVMJQsO5Kvk-brBW8EQ",
  { auth: { persistSession: true, autoRefreshToken: true } }
);

let currentUser = null;

let weeklyPrice = 1500;
let signalsPrice = 300;
let monthlyPrice = 2000;

// =======================================
// LOAD USER
// =======================================
async function loadUser() {
  const { data: { session }} = await supabaseClient.auth.getSession();
  if (!session) return window.location.href = "index.html";

  currentUser = session.user;
  await enforceKYC();
  await loadBalance();
  await loadDeposits();
  updateBonuses();
}

async function enforceKYC() {
  const { data } = await supabaseClient
    .from("profiles")
    .select("*")
    .eq("id", currentUser.id)
    .maybeSingle();

  if (!data || !data.first_name || !data.last_name || !data.dob || !data.mobile) {
    alert("Please complete your profile before accessing your dashboard.");
    window.location.href = "profile.html";
  }
}

// =======================================
// BALANCE + BONUSES
// =======================================
async function loadBalance() {
  const { data } = await supabaseClient
    .from("user_balances")
    .select("balance")
    .eq("id", currentUser.id)
    .single();

  document.getElementById("balance").innerHTML = "R " + Number(data.balance).toFixed(2);
  window.memberBalance = data.balance;
  updateBonuses();
}

function updateBonuses() {
  const list = document.getElementById("bonusList");
  list.innerHTML = "";

  const balance = window.memberBalance || 0;

  if (balance >= 500)
    list.innerHTML += `<div class='bonus-item'>Priority Customer Support</div>`;

  if (balance >= 1500)
    list.innerHTML += `<div class='bonus-item'>Early Access to Trading Signals</div>`;

  if (balance >= 3000)
    list.innerHTML += `<div class='bonus-item'>Premium Insights & Market Reports</div>`;
}

// =======================================
// SERVICES / PURCHASES
// =======================================
async function buyProduct(name, price) {
  if (window.memberBalance < price) {
    alert("Insufficient balance.");
    return;
  }

  await supabaseClient.from("purchases").insert({
    user_id: currentUser.id,
    product_name: name,
    amount: price
  });

  await supabaseClient
    .from("user_balances")
    .update({ balance: window.memberBalance - price })
    .eq("id", currentUser.id);

  alert("Purchase successful!");
  loadBalance();
}

// =======================================
// DEPOSITS
// =======================================
function openDeposit() { document.getElementById("depositModal").style.display = "flex"; }
function closeDeposit() { document.getElementById("depositModal").style.display = "none"; }

function showBank() { closeDeposit(); document.getElementById("bankModal").style.display = "flex"; }
function closeBank() { document.getElementById("bankModal").style.display = "none"; }

function showXRP() { closeDeposit(); document.getElementById("xrpModal").style.display = "flex"; }
function closeXRP() { document.getElementById("xrpModal").style.display = "none"; }

async function submitDeposit(type) {
  let amount = (type === "bank")
    ? Number(document.getElementById("bankAmount").value)
    : Number(document.getElementById("xrpAmount").value);

  if (!amount || amount <= 0) {
    alert("Enter a valid amount.");
    return;
  }

  await supabaseClient.from("deposits").insert({
    user_id: currentUser.id,
    method: type,
    amount,
    status: "pending"
  });

  alert("Deposit submitted. It will update in 5–19 minutes depending on your bank or crypto network.");

  closeBank();
  closeXRP();
  loadDeposits();
}

// =======================================
// DEPOSIT HISTORY
// =======================================
async function loadDeposits() {
  const { data } = await supabaseClient
    .from("deposits")
    .select("*")
    .eq("user_id", currentUser.id)
    .order("id", { ascending:false });

  let html = "";
  data.forEach(d => {
    html += `
      <p><strong>${d.method.toUpperCase()}</strong>: R ${d.amount} — <em>${d.status}</em></p>
    `;
  });

  document.getElementById("depositHistory").innerHTML = html || "No deposits yet.";
}

// =======================================
// PAYOUTS
// =======================================
function openPayout() { document.getElementById("payoutModal").style.display = "flex"; }
function closePayout() { document.getElementById("payoutModal").style.display = "none"; }

async function submitPayout() {
  const amount = Number(document.getElementById("payoutAmount").value);

  if (!amount || amount <= 0) {
    alert("Enter a valid amount.");
    return;
  }

  if (amount > window.memberBalance) {
    alert("You cannot request more than your available balance.");
    return;
  }

  await supabaseClient.from("payouts").insert({
    user_id: currentUser.id,
    amount,
    status: "pending"
  });

  alert("Payout request submitted. Admin will process it shortly.");
  closePayout();
}

// =======================================
// LOGOUT
// =======================================
async function logout() {
  await supabaseClient.auth.signOut();
  window.location.href = "index.html";
}

loadUser();
</script>

</body>
</html>
