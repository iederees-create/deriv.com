<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Deriv Members Dashboard</title>

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800;900&display=swap" rel="stylesheet">

  <style>
    body {
      margin: 0;
      font-family: 'Inter', sans-serif;
      background: #f4f5f7;
      color: #111;
    }

    .header {
      background: #111;
      padding: 16px 24px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      color: white;
      position: sticky;
      top: 0;
      z-index: 10;
    }

    .logout-btn {
      background: #ff4459;
      border: none;
      padding: 10px 16px;
      border-radius: 8px;
      color: white;
      cursor: pointer;
      font-weight: 700;
    }

    .container {
      max-width: 1100px;
      margin: 30px auto;
      padding: 0 16px;
    }

    .section {
      background: white;
      padding: 26px;
      border-radius: 12px;
      margin-bottom: 26px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }

    h1 { font-size: 28px; font-weight: 800; margin-bottom: 14px; }
    h2 { font-size: 22px; font-weight: 700; margin-top: 0; }

    .balance-row {
      display: flex;
      gap: 40px;
      flex-wrap: wrap;
      align-items: baseline;
    }

    .balance-label {
      font-size: 14px;
      color: #555;
    }

    .balance-value {
      font-size: 32px;
      font-weight: 900;
      margin: 4px 0 10px;
    }

    .btn {
      display: inline-block;
      padding: 12px 18px;
      border-radius: 8px;
      font-weight: 700;
      cursor: pointer;
      border: none;
      color: white;
      margin-top: 10px;
    }

    .btn-red { background: #ff4459; }
    .btn-black { background: #111; }

    .product-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(290px, 1fr));
      gap: 20px;
    }

    .card {
      background: white;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 1px 6px rgba(0,0,0,0.08);
    }

    .card h2 { margin-bottom: 6px; }
    .card p { margin-top: 6px; margin-bottom: 10px; }

    .tag {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 999px;
      background: #e5e7eb;
      font-size: 12px;
      font-weight: 600;
    }

    .bonus-item {
      background: #f2f2f2;
      padding: 14px;
      border-radius: 8px;
      margin-top: 10px;
    }

    /* Modals */
    .modal-bg {
      position: fixed;
      inset: 0;
      display: none;
      justify-content: center;
      align-items: center;
      background: rgba(0,0,0,0.6);
      z-index: 999;
    }

    .modal-content {
      background: #fff;
      padding: 26px;
      width: 360px;
      border-radius: 12px;
      text-align: center;
    }

    .modal-content h2 { margin-top: 0; }
    .modal-content input {
      width: 100%;
      padding: 12px;
      margin-top: 12px;
      border-radius: 8px;
      border: 1px solid #ccc;
      font-size: 16px;
    }
  </style>
</head>

<body>

  <!-- HEADER -->
  <div class="header">
    <div style="font-size:20px; font-weight:800;">Deriv Members Portal</div>
    <button class="logout-btn" onclick="logout()">Log out</button>
  </div>

  <div class="container">

    <!-- WALLET -->
    <div class="section">
      <h1>Your Wallet</h1>
      <div class="balance-row">
        <div>
          <div class="balance-label">Available balance</div>
          <div id="balance" class="balance-value">$0.00</div>
        </div>
        <div>
          <div class="balance-label">Invested balance</div>
          <div id="investedBalance" class="balance-value">$0.00</div>
          <div class="balance-label" style="max-width:360px;">
            This is the capital we actively trade for you. Once you invest a minimum of $50 you unlock access to all services.
          </div>
        </div>
      </div>

      <button class="btn btn-red" onclick="openDeposit()">Make a Deposit</button>
      <button class="btn btn-black" onclick="openPayout()">Request Payout</button>
    </div>

    <!-- BONUSES / INCENTIVES -->
    <div class="section">
      <h1>Investment Tiers & Benefits</h1>
      <p>We reward clients who grow their trading capital:</p>

      <div id="bonusList"></div>
    </div>

    <!-- SERVICES -->
    <div class="section">
      <h1>Trading Services</h1>
      <p style="margin-bottom:18px;">
        A one-time <strong>minimum investment of $50</strong> unlocks access to <strong>all three</strong> services below.
        If you click join and don’t have enough available balance, you’ll be taken to the deposit screen.
      </p>

      <div class="product-grid">
        <div class="card">
          <span class="tag">Weekly</span>
          <h2>Weekly Trade Syndicate</h2>
          <p>Active trading pool targeting weekly profit opportunities on major indices and FX.</p>
          <button class="btn btn-black" onclick="joinService('Weekly Syndicate')">Join / Access</button>
        </div>

        <div class="card">
          <span class="tag">On-demand</span>
          <h2>WhatsApp Signals Group</h2>
          <p>Ask for a signal on the chart of your choice and receive focused, technical entries.</p>
          <button class="btn btn-black" onclick="joinService('Signals Group')">Join / Access</button>
        </div>

        <div class="card">
          <span class="tag">Monthly</span>
          <h2>Monthly Syndicate</h2>
          <p>Longer-term positions with more stable monthly growth and lower noise.</p>
          <button class="btn btn-black" onclick="joinService('Monthly Syndicate')">Join / Access</button>
        </div>
      </div>
    </div>

    <!-- DEPOSIT HISTORY -->
    <div class="section">
      <h1>Deposit History</h1>
      <div id="depositHistory"></div>
    </div>

  </div>

  <!-- DEPOSIT SELECT MODAL -->
  <div id="depositModal" class="modal-bg">
    <div class="modal-content">
      <h2>Select Deposit Method</h2>
      <p style="margin-bottom:12px;">Minimum deposit: <strong>$50</strong></p>
      <button class="btn btn-black" onclick="showBank()">Bank Deposit (Nedbank)</button>
      <button class="btn btn-red" onclick="showXRP()">Deposit with XRP</button>
      <button class="btn btn-black" style="background:#666;" onclick="closeDeposit()">Cancel</button>
    </div>
  </div>

  <!-- BANK MODAL -->
  <div id="bankModal" class="modal-bg">
    <div class="modal-content">
      <h2>Bank Deposit</h2>
      <p><strong>Bank:</strong> Nedbank</p>
      <p><strong>Account Type:</strong> Savings</p>
      <p><strong>Account Number:</strong> 1236268857</p>
      <p><strong>Reference:</strong> Your Name + Surname</p>
      <p style="font-size:13px; color:#555;">To help us match your deposit quickly, always use your full name as the reference.</p>

      <input id="bankAmount" type="number" placeholder="Deposit amount in USD (min 50)">
      <button class="btn btn-black" onclick="submitDeposit('bank')">I’ve Made the Deposit</button>
      <button class="btn btn-black" style="background:#666;" onclick="closeBank()">Cancel</button>
    </div>
  </div>

  <!-- XRP MODAL -->
  <div id="xrpModal" class="modal-bg">
    <div class="modal-content">
      <h2>Deposit with XRP</h2>

      <img src="images/xrp_qr.png" style="width:180px; margin-bottom:10px;">

      <p><strong>Address:</strong><br> rsRy14FvipgqudiGmptJBhr1RtpsgfzKMM</p>
      <p><strong>Tag:</strong> 1574868947</p>
      <p style="font-size:13px; color:#555;">Send the equivalent of at least $50 in XRP.</p>

      <input id="xrpAmount" type="number" placeholder="Deposit amount in USD (min 50)">
      <button class="btn btn-red" onclick="submitDeposit('xrp')">I’ve Sent the XRP</button>
      <button class="btn btn-black" style="background:#666;" onclick="closeXRP()">Cancel</button>
    </div>
  </div>

  <!-- PAYOUT MODAL -->
  <div id="payoutModal" class="modal-bg">
    <div class="modal-content">
      <h2>Payout Request</h2>
      <input id="payoutAmount" type="number" placeholder="Amount in USD">
      <button onclick="submitPayout()" class="btn btn-red">Submit Request</button>
      <button onclick="closePayout()" class="btn btn-black" style="background:#666;">Cancel</button>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    const supabaseClient = supabase.createClient(
      "https://whnnyuozicuphrpgomno.supabase.co",
      "YOUR_ANON_KEY_HERE",
      { auth: { persistSession: true, autoRefreshToken: true } }
    );

    let currentUser = null;
    let availableBalance = 0;
    let investedBalance = 0;
    const MIN_INVESTMENT = 50;   // USD minimum to unlock all services

    // =========================
    // CORE LOAD
    // =========================
    async function loadUser() {
      const { data: { session } } = await supabaseClient.auth.getSession();
      if (!session) {
        window.location.href = "index.html";
        return;
      }
      currentUser = session.user;

      await enforceKYC();
      await ensureBalanceRow();
      await loadBalance();
      await loadDeposits();
      updateBonuses();
    }

    async function enforceKYC() {
      const { data } = await supabaseClient
        .from("profiles")
        .select("*")
        .eq("id", currentUser.id)
        .maybeSingle();

      if (!data || !data.first_name || !data.last_name || !data.dob || !data.mobile) {
        alert("Please complete your profile before using your dashboard.");
        window.location.href = "profile.html";
      }
    }

    async function ensureBalanceRow() {
      const { data: existing } = await supabaseClient
        .from("user_balances")
        .select("*")
        .eq("id", currentUser.id)
        .maybeSingle();

      if (!existing) {
        await supabaseClient.from("user_balances").insert({
          id: currentUser.id,
          balance: 0,
          invested_balance: 0
        });
      }
    }

    async function loadBalance() {
      const { data } = await supabaseClient
        .from("user_balances")
        .select("balance, invested_balance")
        .eq("id", currentUser.id)
        .single();

      availableBalance = Number(data.balance || 0);
      investedBalance = Number(data.invested_balance || 0);

      document.getElementById("balance").innerText = "$" + availableBalance.toFixed(2);
      document.getElementById("investedBalance").innerText = "$" + investedBalance.toFixed(2);

      updateBonuses();
    }

    // =========================
    // BONUS / INCENTIVES
    // =========================
    function updateBonuses() {
      const box = document.getElementById("bonusList");
      box.innerHTML = "";

      const totalCapital = investedBalance;

      box.innerHTML += `
        <div class="bonus-item">
          <strong>$50+ invested:</strong> Unlocks all services (Weekly Syndicate, Signals Group, Monthly Syndicate).
        </div>
      `;

      if (totalCapital >= 250) {
        box.innerHTML += `
          <div class="bonus-item">
            <strong>$250+ invested:</strong> Priority payout queue + personalised trade feedback once a week.
          </div>
        `;
      }

      if (totalCapital >= 500) {
        box.innerHTML += `
          <div class="bonus-item">
            <strong>$500+ invested:</strong> VIP treatment – direct line for questions, early access to new strategies.
          </div>
        `;
      }

      if (totalCapital >= 1000) {
        box.innerHTML += `
          <div class="bonus-item">
            <strong>$1000+ invested:</strong> Quarterly performance review and tailored scaling plan for your account.
          </div>
        `;
      }
    }

    // =========================
    // JOIN SERVICES (ALL ACCESS)
    // =========================
    async function joinService(serviceName) {
      // If already invested enough, just record access
      if (investedBalance >= MIN_INVESTMENT) {
        await supabaseClient.from("purchases").insert({
          user_id: currentUser.id,
          product_name: serviceName + " (all-access)",
          amount: 0
        });
        alert("You already have an active investment. " + serviceName + " is now available to you.");
        return;
      }

      // Not enough invested – check available balance
      if (availableBalance < MIN_INVESTMENT) {
        alert("You need at least $" + MIN_INVESTMENT + " available to activate your investment.\n\nWe'll take you to the deposit screen.");
        openDeposit();
        return;
      }

      // Move $50 from available → invested
      const newAvailable = availableBalance - MIN_INVESTMENT;
      const newInvested = investedBalance + MIN_INVESTMENT;

      await supabaseClient
        .from("user_balances")
        .update({ balance: newAvailable, invested_balance: newInvested })
        .eq("id", currentUser.id);

      await supabaseClient.from("purchases").insert({
        user_id: currentUser.id,
        product_name: "All Services Membership",
        amount: MIN_INVESTMENT
      });

      availableBalance = newAvailable;
      investedBalance = newInvested;

      await loadBalance();

      alert(
        "Your $50 investment is now active.\n\n" +
        "You can use all three services without extra charges. Admin will grow this invested balance as your profile grows."
      );
    }

    // =========================
    // DEPOSITS
    // =========================
    function openDeposit() { document.getElementById("depositModal").style.display = "flex"; }
    function closeDeposit() { document.getElementById("depositModal").style.display = "none"; }
    function showBank() { closeDeposit(); document.getElementById("bankModal").style.display = "flex"; }
    function closeBank() { document.getElementById("bankModal").style.display = "none"; }
    function showXRP() { closeDeposit(); document.getElementById("xrpModal").style.display = "flex"; }
    function closeXRP() { document.getElementById("xrpModal").style.display = "none"; }

    async function submitDeposit(type) {
      const amount = type === "bank"
        ? Number(document.getElementById("bankAmount").value)
        : Number(document.getElementById("xrpAmount").value);

      if (!amount || amount <= 0) {
        alert("Enter a valid amount.");
        return;
      }

      if (amount < MIN_INVESTMENT) {
        alert("Minimum deposit is $" + MIN_INVESTMENT + ".");
        return;
      }

      await supabaseClient.from("deposits").insert({
        user_id: currentUser.id,
        method: type,
        amount,
        status: "pending"
      });

      alert(
        "Deposit submitted.\n\n" +
        "Status: Pending\n" +
        "It will typically reflect on your dashboard within 5–19 minutes depending on your bank or the XRP network."
      );

      closeBank();
      closeXRP();
      await loadDeposits();
    }

    // =========================
    // DEPOSIT HISTORY
    // =========================
    async function loadDeposits() {
      const { data } = await supabaseClient
        .from("deposits")
        .select("*")
        .eq("user_id", currentUser.id)
        .order("id", { ascending: false });

      const area = document.getElementById("depositHistory");
      if (!data || data.length === 0) {
        area.innerHTML = "No deposits yet.";
        return;
      }

      let html = "";
      data.forEach(d => {
        html += `<p><strong>${d.method.toUpperCase()}</strong> &mdash; $${Number(d.amount).toFixed(2)} — <em>${d.status}</em></p>`;
      });
      area.innerHTML = html;
    }

    // =========================
    // PAYOUTS
    // =========================
    function openPayout() { document.getElementById("payoutModal").style.display = "flex"; }
    function closePayout() { document.getElementById("payoutModal").style.display = "none"; }

    async function submitPayout() {
      const amount = Number(document.getElementById("payoutAmount").value);

      if (!amount || amount <= 0) {
        alert("Enter a valid amount.");
        return;
      }

      if (amount > availableBalance) {
        alert("You cannot request more than your available balance.");
        return;
      }

      await supabaseClient.from("payouts").insert({
        user_id: currentUser.id,
        amount,
        status: "pending"
      });

      alert("Payout request submitted. We’ll process it as soon as possible.");
      closePayout();
    }

    // =========================
    // LOGOUT
    // =========================
    async function logout() {
      await supabaseClient.auth.signOut();
      window.location.href = "index.html";
    }

    loadUser();
  </script>

</body>
</html>
